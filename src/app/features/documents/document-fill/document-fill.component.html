<div class="w-full min-h-screen bg-background">
  <div class="mx-auto max-w-4xl px-4 py-6">
    @if (loading()) {
      <div class="flex justify-center items-center h-64">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-primary"></div>
      </div>
    } @else if (document()) {
      <!-- Header -->
      <div class="mb-8 print:mb-4">
        <h1 class="text-2xl font-bold tracking-tight">{{ document()!.title }}</h1>
        @if (document()!.description) {
          <p class="mt-2 text-sm text-muted-foreground">{{ document()!.description }}</p>
        }
        @if (document()!.is_required) {
          <div class="mt-3 inline-flex items-center gap-2 rounded-full bg-orange-100 px-3 py-1 text-sm font-medium text-orange-800 print:hidden">
            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
            </svg>
            Required Document
          </div>
        }
      </div>

      <!-- Form -->
      <div class="rounded-lg border border-border bg-card p-8 shadow-sm print:border-0 print:shadow-none">
        <div class="space-y-6">
          @for (field of getTemplateFields(); track field.id) {
            <div class="print:break-inside-avoid">
              <label class="block text-sm font-medium mb-2">
                {{ field.label }}
                @if (field.required) {
                  <span class="text-destructive">*</span>
                }
              </label>

              @switch (field.type) {
                @case ('text') {
                  <input
                    type="text"
                    [value]="formData()[field.id]"
                    (input)="updateField(field.id, $any($event.target).value)"
                    [placeholder]="field.placeholder || ''"
                    [required]="field.required"
                    [style.width.px]="field.width"
                    class="w-full max-w-full rounded-lg border border-input bg-background px-3 py-2 text-sm print:border-b print:border-t-0 print:border-l-0 print:border-r-0 print:rounded-none print:px-0"
                  />
                }

                @case ('textarea') {
                  <textarea
                    [value]="formData()[field.id]"
                    (input)="updateField(field.id, $any($event.target).value)"
                    [placeholder]="field.placeholder || ''"
                    [required]="field.required"
                    [style.width.px]="field.width"
                    [style.height.px]="field.height"
                    class="w-full max-w-full rounded-lg border border-input bg-background px-3 py-2 text-sm print:border print:rounded-none print:px-1"
                  ></textarea>
                }

                @case ('number') {
                  <input
                    type="number"
                    [value]="formData()[field.id]"
                    (input)="updateField(field.id, +$any($event.target).value)"
                    [placeholder]="field.placeholder || ''"
                    [required]="field.required"
                    [style.width.px]="field.width"
                    class="w-full max-w-full rounded-lg border border-input bg-background px-3 py-2 text-sm print:border-b print:border-t-0 print:border-l-0 print:border-r-0 print:rounded-none print:px-0"
                  />
                }

                @case ('date') {
                  <input
                    type="date"
                    [value]="formData()[field.id]"
                    (change)="updateField(field.id, $any($event.target).value)"
                    [required]="field.required"
                    [style.width.px]="field.width"
                    class="w-full max-w-full rounded-lg border border-input bg-background px-3 py-2 text-sm print:border-b print:border-t-0 print:border-l-0 print:border-r-0 print:rounded-none print:px-0"
                  />
                }

                @case ('checkbox') {
                  <div class="flex items-center gap-2">
                    <input
                      type="checkbox"
                      [checked]="formData()[field.id]"
                      (change)="updateField(field.id, $any($event.target).checked)"
                      [required]="field.required"
                      class="h-4 w-4 rounded border-input"
                    />
                    <span class="text-sm">{{ field.placeholder || 'Check if applicable' }}</span>
                  </div>
                }

                @case ('dropdown') {
                  <select
                    [value]="formData()[field.id]"
                    (change)="updateField(field.id, $any($event.target).value)"
                    [required]="field.required"
                    [style.width.px]="field.width"
                    class="w-full max-w-full rounded-lg border border-input bg-background px-3 py-2 text-sm print:border-b print:border-t-0 print:border-l-0 print:border-r-0 print:rounded-none print:px-0"
                  >
                    <option value="">Select an option</option>
                    @for (option of field.options; track option) {
                      <option [value]="option">{{ option }}</option>
                    }
                  </select>
                }

                @case ('file') {
                  <div class="print:hidden">
                    <app-image-upload
                      [imageUrl]="formData()[field.id] || ''"
                      (imageUrlChange)="updateField(field.id, $event)"
                      [mediaType]="'any'"
                      [maxSize]="10"
                    />
                  </div>
                  @if (formData()[field.id]) {
                    <div class="hidden print:block mt-2 text-sm">
                      File attached: {{ formData()[field.id] }}
                    </div>
                  }
                }

                @case ('signature') {
                  <div class="border-2 border-border rounded-lg p-4 text-center bg-muted print:bg-white"
                       [style.width.px]="field.width"
                       [style.height.px]="field.height || 100">
                    <input
                      type="text"
                      [value]="formData()[field.id]"
                      (input)="updateField(field.id, $any($event.target).value)"
                      placeholder="Type your signature"
                      class="w-full h-full text-center text-2xl font-signature bg-transparent border-0 outline-none"
                    />
                  </div>
                }
              }
            </div>
          }
        </div>
      </div>

      <!-- Actions -->
      <div class="mt-6 flex gap-4 print:hidden">
        <button
          (click)="submitForm()"
          [disabled]="isSubmitting()"
          class="rounded-lg bg-primary px-6 py-3 text-sm font-semibold text-primary-foreground hover:bg-primary/90 disabled:opacity-50"
        >
          @if (isSubmitting()) {
            <span class="flex items-center gap-2">
              <svg class="h-4 w-4 animate-spin" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
              </svg>
              Submitting...
            </span>
          } @else {
            <span>Submit Form</span>
          }
        </button>
        <button
          (click)="saveDraft()"
          [disabled]="isSubmitting()"
          class="rounded-lg border border-border bg-background px-6 py-3 text-sm font-semibold hover:bg-accent disabled:opacity-50"
        >
          Save Draft
        </button>
        <button
          (click)="printForm()"
          class="rounded-lg border border-border bg-background px-6 py-3 text-sm font-semibold hover:bg-accent ml-auto"
        >
          <svg class="inline-block w-4 h-4 mr-2 -mt-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z" />
          </svg>
          Print / PDF
        </button>
        <button
          (click)="cancel()"
          [disabled]="isSubmitting()"
          class="rounded-lg border border-border bg-background px-6 py-3 text-sm font-semibold hover:bg-accent disabled:opacity-50"
        >
          Cancel
        </button>
      </div>
    }
  </div>
</div>
